name: Celix

on: [push, pull_request]

jobs:
  Build:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [macOS-10.14]
        #os: [ubuntu-18.04, ubuntu-16.04, macOS-10.14]
        compiler: [gcc, clang]
        include:
          - os: ubuntu-18.04
            compiler: gcc
            sanitize: true
    timeout-minutes: 120
    steps:
    - name: Checkout source code
      uses: actions/checkout@master
    - name: Install dependencies
      run: |
        if [[ "${{ matrix.os }}" == "ubuntu"* ]]; then
          sudo apt-get install -yq --no-install-recommends \
            build-essential \
            curl \
            uuid-dev \
            libjansson-dev \
            libcurl4-openssl-dev \
            default-jdk \
            cmake \
            libffi-dev \
            libxml2-dev \
            libczmq-dev \
            libcpputest-dev
        fi
        if [[ "${{ matrix.os }}" == "macOS"* ]]; then
          brew update
          brew install lcov libffi zeromq czmq openssl cpputest
          brew link --force libffi
          brew unlink openssl && brew link openssl --force
        fi
        cd $GITHUB_WORKSPACE
    - name: Build
      env:
        CC: ${{ matrix.compiler }}
        BUILD_OPTIONS: |
          -DBUILD_DEPLOYMENT_ADMIN=ON
          -DBUILD_DEPENDENCY_MANAGER=ON
          -DBUILD_EXAMPLES=ON -DBUILD_LOG_SERVICE=ON
          -DBUILD_LOG_WRITER=ON
          -DBUILD_REMOTE_SERVICE_ADMIN=OFF
          -DBUILD_RSA_REMOTE_SERVICE_ADMIN_DFI=OFF
          -DBUILD_RSA_DISCOVERY_CONFIGURED=ON
          -DBUILD_RSA_DISCOVERY_ETCD=ON
          -DBUILD_RSA_EXAMPLES=ON
          -DBUILD_REMOTE_SHELL=ON
          -DBUILD_SHELL=ON
          -DBUILD_SHELL_TUI=ON -DBUILD_DEVICE_ACCESS=ON
          -DBUILD_DEVICE_ACCESS_EXAMPLE=ON
          -DBUILD_HTTP_ADMIN=ON
        BUILD_OPTIONS_LINUX: |
          -DBUILD_RSA_REMOTE_SERVICE_ADMIN_SHM=ON
          -DBUILD_PUBSUB=ON
          -DBUILD_PUBSUB_PSA_ZMQ=ON
          -DBUILD_PUBSUB_TESTS=ON
          -DBUILD_RSA_DISCOVERY_SHM=ON
        BUILD_OPTIONS_OSX: |
          -DBUILD_RSA_REMOTE_SERVICE_ADMIN_SHM=OFF
          -DBUILD_PUBSUB=OFF
          -DBUILD_RSA_DISCOVERY_SHM=OFF
        BUILD_OPTIONS_SANITIZE: |
          -DENABLE_ADDRESS_SANITIZER=ON
      run: |
        mkdir build install
        cd build
        if [[ "${{ matrix.sanitize }}" == "true" ]]; then
          export BUILD_OPTIONS="${BUILD_OPTIONS} ${BUILD_OPTIONS_SANITIZE}"
        fi
        if [[ "${{ matrix.os }}" == "ubuntu"* ]]; then
          cmake -DCMAKE_BUILD_TYPE=Debug ${BUILD_OPTIONS} ${BUILD_OPTIONS_LINUX} \
              -DBUILD_FRAMEWORK_TESTS=ON \
              -DBUILD_UTILS-TESTS=ON \
              -DENABLE_TESTING=ON ${BUILD_OPTS} \
              -DCMAKE_INSTALL_PREFIX=../install ..
        fi
        if [[ "${{ matrix.os }}" == "macOS"* ]]; then
          cmake -DCMAKE_BUILD_TYPE=Debug ${BUILD_OPTIONS} ${BUILD_OPTIONS_OSX} \
              -DBUILD_FRAMEWORK_TESTS=ON \
              -DBUILD_UTILS-TESTS=ON \
              -DENABLE_TESTING=ON \
              -DFFI_INCLUDE_DIR=/usr/local/opt/libffi/lib/libffi-3.2.1/include \
              -DFFI_LIBRARY=/usr/local/opt/libffi/lib/libffi.dylib \
              ${BUILD_OPTS} \
              -DCMAKE_INSTALL_PREFIX=../install ..
        fi
        make all && make deploy && make install
    - name: Test
      run: |
        cd $GITHUB_WORKSPACE/build
        export LD_LIBRARY_PATH=/usr/local/lib:$LD_LIBRARY_PATH:$(pwd)/utils:$(pwd)/framework:$(pwd)/dfi
        make test ARGS="-V"

